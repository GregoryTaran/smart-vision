<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Smart Vision ‚Äî Calls</title>
  <link rel="stylesheet" href="../css/main.css">
  <style>
    body { background: #f0f0f0; margin: 0; font-family: sans-serif; }
    .container { max-width: 900px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { font-size: 22px; margin-bottom: 10px; }
    .user-block { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding: 10px 0; }
    button { background: #fff; border: 1px solid #aaa; padding: 6px 12px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
    button:hover { background: #eee; }
    #log { background: #fafafa; border: 1px solid #ccc; border-radius: 10px; padding: 10px; height: 150px; overflow-y: auto; font-size: 14px; margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìû Vision Calls</h1>
    <p id="currentUser">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</h3>
    <div id="usersList">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</div>

    <h3>–õ–æ–≥–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:</h3>
    <div id="log"></div>
    <audio id="remoteAudio" autoplay></audio>
  </div>

  <!-- üîπ –û–±—â–∏–π —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <script src="../js/auth-check.js"></script>

  <!-- üîπ –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ -->
  <script type="module">
    import { setupVisionCalls } from "../js/vision-call.js";

    // –î–æ–∂–∏–¥–∞–µ–º—Å—è, –ø–æ–∫–∞ auth-check –ø–æ–¥—Ç—è–Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const checkInterval = setInterval(async () => {
      if (window.firebaseApp && window.firebaseAuth && window.firebaseDb) {
        clearInterval(checkInterval);

        const db = window.firebaseDb;
        const auth = window.firebaseAuth;
        const logEl = document.getElementById("log");
        const usersList = document.getElementById("usersList");
        const audio = document.getElementById("remoteAudio");

        const log = msg => {
          logEl.innerHTML += msg + "<br>";
          logEl.scrollTop = logEl.scrollHeight;
          console.log(msg);
        };

        if (auth.currentUser) {
          document.getElementById("currentUser").textContent =
            "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: " + auth.currentUser.email;
          await setupVisionCalls({ db, auth, usersList, audio, log });
        } else {
          document.getElementById("currentUser").textContent =
            "–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞...";
          setTimeout(() => (window.location.href = "login.html"), 1500);
        }
      }
    }, 300);
  </script>
</body>
</html>
