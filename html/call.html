<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Smart Vision ‚Äî Calls</title>
  <link rel="stylesheet" href="../css/main.css" />
  <style>
    body {
      background: #f0f0f0;
      margin: 0;
      font-family: sans-serif;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .white-block {
      background: #fff;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      border-radius: 0 0 20px 20px;
    }
    #user-info {
      font-size: 14px;
      color: #333;
    }
    #logout {
      background: #fff;
      border: 1px solid #aaa;
      border-radius: 8px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
    }
    #logout:hover {
      background: #eee;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 10px;
    }
    .user-block {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #ddd;
      padding: 10px 0;
    }
    button {
      background: #fff;
      border: 1px solid #aaa;
      padding: 6px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.2s;
    }
    button:hover {
      background: #eee;
    }
    #log {
      background: #fafafa;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      height: 150px;
      overflow-y: auto;
      font-size: 14px;
      margin-top: 20px;
    }
    #controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
  </style>
</head>
<body>
  <!-- üîπ –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å (—Ç–∞ –∂–µ, —á—Ç–æ –Ω–∞ dashboard) -->
  <div id="user-bar" class="white-block">
    <span id="user-info">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    <button id="logout">–í—ã–π—Ç–∏</button>
  </div>

  <!-- üîπ –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ –∑–≤–æ–Ω–∫–æ–≤ -->
  <div class="container">
    <h1>üìû Vision Calls</h1>
    <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</h3>
    <div id="usersList">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞...</div>

    <h3>–õ–æ–≥–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:</h3>
    <div id="log"></div>

    <div id="controls">
      <button id="muteBtn">üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
      <button id="endBtn">üì¥ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
    </div>

    <audio id="remoteAudio" autoplay></audio>
  </div>

  <!-- üîπ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
  <script src="../js/auth-check.js"></script>

  <!-- üîπ –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
    import { setupVisionCalls } from "../js/vision-call.js";

    const wait = ms => new Promise(r => setTimeout(r, ms));
    while (!window.currentUser) {
      await wait(100);
    }

    const res = await fetch(
      "https://us-central1-smart-vision-888.cloudfunctions.net/getFirebaseConfig"
    );
    const { ok, config } = await res.json();
    if (!ok || !config) {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Firebase config");
      throw new Error("No Firebase config");
    }

    const app = initializeApp(config);
    const db = getFirestore(app);

    const usersList = document.getElementById("usersList");
    const audio = document.getElementById("remoteAudio");
    const logEl = document.getElementById("log");
    const log = msg => {
      logEl.innerHTML += msg + "<br>";
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    };

    await setupVisionCalls({ db, usersList, audio, log });
  </script>
</body>
</html>
