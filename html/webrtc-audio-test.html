<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Vision WebRTC Debug</title>
  <style>
    body { font-family: sans-serif; background: #f6f6f6; padding: 20px; }
    textarea { width: 100%; height: 180px; margin: 10px 0; font-family: monospace; }
    button { margin: 5px; padding: 10px 16px; font-size: 16px; }
    #log { background: #fff; border: 1px solid #ccc; padding: 10px; height: 150px; overflow-y: auto; font-size: 14px; }
  </style>
</head>
<body>
  <h2>üéß Vision WebRTC Debug</h2>
  <button id="startCall">üìû –°–æ–∑–¥–∞—Ç—å –∑–≤–æ–Ω–æ–∫</button>
  <button id="answerCall">‚úÖ –û—Ç–≤–µ—Ç–∏—Ç—å</button>
  <button id="enableAudio">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
  <textarea id="signal" placeholder="–í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞"></textarea>
  <div id="log"></div>
  <audio id="remoteAudio" autoplay></audio>

  <script>
    const log = msg => {
      const el = document.getElementById('log');
      el.innerHTML += msg + '<br>';
      el.scrollTop = el.scrollHeight;
      console.log(msg);
    };

    const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    const signalBox = document.getElementById('signal');
    const audio = document.getElementById('remoteAudio');

    pc.oniceconnectionstatechange = () => log('ICE: ' + pc.iceConnectionState);
    pc.onconnectionstatechange = () => log('PC: ' + pc.connectionState);
    pc.onicecandidate = e => {
      if (!e.candidate) {
        signalBox.value = JSON.stringify(pc.localDescription);
        log('üì® –°–∫–æ–ø–∏—Ä—É–π –∏ –≤—Å—Ç–∞–≤—å —ç—Ç–æ—Ç JSON –Ω–∞ –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ');
      }
    };
    pc.ontrack = e => {
      log('üéß –ü–æ–ª—É—á–µ–Ω –∞—É–¥–∏–æ–ø–æ—Ç–æ–∫');
      audio.srcObject = e.streams[0];
      audio.play().catch(err => log('‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–≤—É–∫: ' + err.message));
    };

    async function getMic() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(t => pc.addTrack(t, stream));
      log('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω');
    }

    document.getElementById('startCall').onclick = async () => {
      await getMic();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      log('üöÄ Offer —Å–æ–∑–¥–∞–Ω');
    };

    document.getElementById('answerCall').onclick = async () => {
      await getMic();
      const desc = JSON.parse(signalBox.value);
      await pc.setRemoteDescription(desc);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      signalBox.value = JSON.stringify(answer);
      log('‚úÖ Answer —Å–æ–∑–¥–∞–Ω ‚Äî –æ—Ç–ø—Ä–∞–≤—å –æ–±—Ä–∞—Ç–Ω–æ');
    };

    signalBox.addEventListener('input', async () => {
      try {
        const data = JSON.parse(signalBox.value);
        if (!pc.currentRemoteDescription && data.type) {
          await pc.setRemoteDescription(data);
          log('üîó –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —É–¥–∞–ª—ë–Ω–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: ' + data.type);
        }
      } catch {}
    });

    document.getElementById('enableAudio').onclick = () => {
      audio.play().then(() => log('üîä –ó–≤—É–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω –≤—Ä—É—á–Ω—É—é')).catch(err => log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–≤—É–∫–∞: ' + err.message));
    };
  </script>
</body>
</html>
